<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="xmap">
<title>Intro to Crossmaps • xmap</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Intro to Crossmaps">
<meta property="og:description" content="xmap">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">xmap</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1.9002</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/xmap.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/making-xmaps.html">Intro to Crossmaps</a>
    <a class="dropdown-item" href="../articles/vis-xmaps.html">Visualising Crossmap Transformations</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/cynthiahqy/xmap/">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Intro to Crossmaps</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cynthiahqy/xmap/vignettes/making-xmaps.Rmd" class="external-link"><code>vignettes/making-xmaps.Rmd</code></a></small>
      <div class="d-none name"><code>making-xmaps.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cynthiahqy/xmap" class="external-link">xmap</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction-to-crossmaps">Introduction to Crossmaps<a class="anchor" aria-label="anchor" href="#introduction-to-crossmaps"></a>
</h2>
<p>A (Nomenclature) Crossmap encodes a complete redistribution of values
between a source and target classifications as a directed, bipartite,
weighted graph. Numeric values transformed using a valid Crossmap will
sum to the same total in both the source and target classifications. A
valid Crossmap satisfies the following conditions:</p>
<ol style="list-style-type: decimal">
<li>There is at most one link between each distinct source and target
node</li>
<li>For each source node, the sum of weights attached to all outgoing
links sums to one.</li>
</ol>
<p>For example, this mapping between occupation codes in ANZSCO22 and
ISCO8 is a valid crossmap:</p>
<div class="float">
<img src="plot-anzsco-isco-bigraph.png" alt="A crossmap for converting Australian occupation categories (ANZSCO22) to an international standard (ISCO8)."><div class="figcaption">A crossmap for converting Australian occupation
categories (ANZSCO22) to an international standard (ISCO8).</div>
</div>
<div class="section level3">
<h3 id="unit-and-fractional-weight-links">Unit and Fractional Weight Links<a class="anchor" aria-label="anchor" href="#unit-and-fractional-weight-links"></a>
</h3>
<p>The weights associated with each source-target link encode the
transformation to be applied to values associated with a given source
node. Let the weight between source node <span class="math inline">\(i\)</span> and target node <span class="math inline">\(j\)</span> be denoted <span class="math inline">\(w_{ij}\)</span>. Weights can range from <span class="math inline">\([0,1]\)</span>. Note that <span class="math inline">\(w_{ij} = 0\)</span> is the trivial case where
there is no link between the source and target nodes. The non-trivial
cases are unit weights, <span class="math inline">\(w_{ij} = 1\)</span>
and fractional weights, <span class="math inline">\(w_{ij} \in
(0,1)\)</span>.</p>
<p>Unit weights indicate that source values will be unmodified when
passed into the target nomenclature. Therefore, crosswalks for recoding
node labels, or collapsing multiple sub-category source nodes into
parent target nodes, can both be represented as crossmaps with unit
weights.</p>
<p>Fractional weights on the other hand indicate how a source value will
be modified when passed to the target node. For example a link with a
weight of <span class="math inline">\(0.7\)</span> indicates that 70% of
the numeric value associated with a source node should be “passed over”
to the target node.</p>
<p>Now, consider two links from the same source node <span class="math inline">\(i\)</span> to two different target nodes <span class="math inline">\(j\)</span> and <span class="math inline">\(k\)</span>, with weights <span class="math inline">\(w_{ij}\)</span> and <span class="math inline">\(w_{ik}\)</span>. Assume that the source node <span class="math inline">\(i\)</span> has no other outgoing links into the
target nomenclature. Then, it follows that the weights on the two given
links should sum to one if we want to preserve the total value between
the source and target nomenclature. For instance, if <span class="math inline">\(w_{ij} = 0.7\)</span>, then <span class="math inline">\(w_{ik}\)</span> should be <span class="math inline">\(0.3\)</span>, such that 70% of the value
associated with source node <span class="math inline">\(i\)</span> goes
to the target node <span class="math inline">\(j\)</span>, and the
remaining 30% is distributed to target node <span class="math inline">\(k\)</span>.</p>
</div>
<div class="section level3">
<h3 id="crossmap-tables">Crossmap tables<a class="anchor" aria-label="anchor" href="#crossmap-tables"></a>
</h3>
<p>Crossmap tables are extensions of crosswalk or lookup tables, where
each row represents a weighted link between the source and target
classifications. You can pass a data.frame or tibble of weighted edges
to <code><a href="../reference/verify_links_as_xmap.html">verify_links_as_xmap()</a></code> to check if the input satisfies
crossmap properties.</p>
<p>Your input table <code>x</code> needs to have at least 3 complete
(i.e. no <code>NA</code>) columns:</p>
<ul>
<li>
<code>from</code>: source classification labels.</li>
<li>
<code>to</code>: target classification labels</li>
<li>
<code>weights</code>: applied to values in the source
classification</li>
</ul>
<p>Additional columns (e.g. for label descriptions etc.) can be retained
by setting the <code>.drop_extra</code> argument to
<code>FALSE</code>.</p>
<p><code>verify_links_as_xmap</code> and <code><a href="../reference/as_xmap.html">as_xmap_df()</a></code> will
validate that:</p>
<ol style="list-style-type: decimal">
<li>There are no duplicates <code>from</code>-<code>to</code>
pairs,</li>
<li>Every group of <code>weights</code> associated with a distinct
<code>from</code> value sums to 1 (subject to a floating point
tolerance).</li>
</ol>
<p>The package also offers a experimental <code>xmap_df</code> class
facilitate additional functionality such as graph property calculation
and printing (i.e. relation types and crossmap direction) via a custom
<code><a href="https://rdrr.io/r/base/print.html" class="external-link">print()</a></code> method, coercion to other useful classes
(e.g. <code><a href="../reference/xmap_to_matrix.html">xmap_to_matrix()</a></code>), visualisation (see
<code><a href="../articles/vis-xmaps.html">vignette("vis-xmaps")</a></code> for prototypes), and multi-step
transformations (i.e. from nomenclature A to B to C).</p>
<p>Please note that the <code>xmap_df</code> class and related functions
are still in active development and subject to breaking changes in
future releases.</p>
</div>
</div>
<div class="section level2">
<h2 id="special-cases-of-crossmaps">Special Cases of Crossmaps<a class="anchor" aria-label="anchor" href="#special-cases-of-crossmaps"></a>
</h2>
<p>The conditions for valid nomenclature crossmaps defined above are
sufficient to ensure that the total sum of value is retained between the
source and target nomenclature However, there are a number of other
transformation properties which crossmaps can also encode and validate.
Such special cases include “degenerate” crossmaps. We consider a
crossmap “degenerate” if it has only binary weights on all possible
source-target links. In such cases the weights are implied by the
presence or absence of a link.</p>
<div class="section level3">
<h3 id="types-of-mapping-relations">Types of Mapping Relations<a class="anchor" aria-label="anchor" href="#types-of-mapping-relations"></a>
</h3>
<p>It is helpful when thinking about special cases to define some
familiar types of relations:</p>
<ul>
<li>
<strong>one-to-one</strong>: a set of links where pairs of source
and target nodes are uniquely linked to each other and no other nodes.
Any links in this type of relation will have unit weights.</li>
<li>
<strong>one-to-many</strong>: a set of links where a single source
node is linked to multiple target nodes. Links in this “splitting”
relation will have fractional weights.</li>
<li>
<strong>one-from-many</strong>: a set of links where a single target
node is linked to multiple source nodes. This “collapse” relation is
more commonly known as a <strong>many-to-one</strong>. Links can have
either unit or fractional weights depending on whether the source nodes
are part of one-to-one or one-to-many relations.</li>
<li>
<strong>many-to-many</strong>: refers to a combination of the above
relations and is often used to signal that a correspondence between sets
has both <strong>one-to-many</strong> splitting relations and
<strong>one-from-many</strong> collapsing relations.</li>
</ul>
<p>Note that links in a crossmap can be partitioned into subgraphs
according to the number of outgoing links (i.e. one-to-one and
one-to-many)</p>
</div>
<div class="section level3">
<h3 id="recode-maps">Recode maps<a class="anchor" aria-label="anchor" href="#recode-maps"></a>
</h3>
<p>Crossmaps with only one-to-one relations recode source labels to
target labels, leaving any attached values untouched. This implies that
the weights on links are always 1. Notice that Schema Crosswalks, lookup
tables and category recoding functions are all Recode Maps.</p>
<p>A common way of implementing recodings in R is named vectors or
pairwise arguments such as in <code><a href="https://forcats.tidyverse.org/reference/fct_recode.html" class="external-link">forcats::fct_recode()</a></code>. Named
vectors are a convenient way to store and use one-to-one and many-to-one
mappings. In general it is not necessary to convert such mappings into
crossmaps unless you want to combine them with fractional weight links.
However, when necessary, named vectors can be converted into
<code>xmap</code> by first transforming vector into two-column table of
node pairs, and then attaching the implied unit weights.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># example using the named vector included in `mock` objects:</span></span>
<span><span class="va">mock</span><span class="op">$</span><span class="va">recode_vect</span></span>
<span></span>
<span><span class="va">recode_xmap</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">xmap</span><span class="fu">::</span><span class="fu"><a href="../reference/as_pairs.html">as_pairs_from_named</a></span><span class="op">(</span><span class="va">mock</span><span class="op">$</span><span class="va">recode_vect</span>, names_to <span class="op">=</span> <span class="st">"iso3"</span>, values <span class="op">=</span> <span class="st">"ctr_name"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">xmap</span><span class="fu">::</span><span class="fu"><a href="../reference/add_weights.html">add_weights_unit</a></span><span class="op">(</span>weights_into <span class="op">=</span> <span class="st">"w"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">xmap</span><span class="fu">::</span><span class="fu"><a href="../reference/as_xmap.html">as_xmap_df</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">iso3</span>, to <span class="op">=</span> <span class="va">ctr_name</span>, weights <span class="op">=</span> <span class="va">w</span><span class="op">)</span></span></code></pre></div>
<p>For a crossmap to be a recode map it must have binary weights, and
the cardinality of the source and target node sets must be equal. In
other words, weights can only be 0 (i.e. no link) or 1, and the number
of unique source and target labels should be the same. The function
<code><a href="../reference/verify_named.html">verify_named_all_1to1()</a></code> or its alias
<code><a href="../reference/verify_named.html">verify_named_as_recode_unique()</a></code> uses the cardinality
condition to verify whether or not a named vector has only one-to-one
relation:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fruit_color</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>apple <span class="op">=</span> <span class="st">"green"</span>, strawberry <span class="op">=</span> <span class="st">"red"</span>, banana <span class="op">=</span> <span class="st">"yellow"</span><span class="op">)</span></span>
<span><span class="va">fruit_color</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/verify_named.html">verify_named_all_1to1</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##      apple strawberry     banana </span></span>
<span><span class="co">##    "green"      "red"   "yellow"</span></span></code></pre>
<p>We can also identify mistakes such as accidentally assigning a value
twice:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fruit_color_mistake</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">fruit_color</span>, pear <span class="op">=</span> <span class="st">"green"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fruit_color_mistake</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/verify_named.html">verify_named_as_recode_unique</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `verify_named_as_recode_unique()`:</span></span></span>
<span><span class="co">## <span style="color: #BBBB00;">!</span> Not all relations in `x` are 1-to-1.</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="collapse-or-aggregation-maps">Collapse or Aggregation maps<a class="anchor" aria-label="anchor" href="#collapse-or-aggregation-maps"></a>
</h3>
<p>Collapse crossmaps are similar to Recode crossmaps in that source
values are unmodified when passed into the target nomenclature. However,
as the name suggests, multiple source nodes can be “collapsed” into the
same target node, such that at least some of the source values will be
aggregated in the target nomenclature. Similar to a Recode crossmap, a
Collapse crossmap must only have unit weights, but the cardinality of
the source node set will be larger than the target node set. This means
that at least two source nodes must be linked to the same target node
since there are fewer target nodes than source nodes.</p>
<p>Similar to the recode maps, collapse maps only have unit weights.
Hence, we can use named lists to store such mappings. Consider an
example such as assigning students to groups. Assume no two students
share the same name:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">student_groups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>GRP1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"kate"</span>, <span class="st">"jane"</span>, <span class="st">"peter"</span><span class="op">)</span>,</span>
<span>                       GRP2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"terry"</span>, <span class="st">"ben"</span>, <span class="st">"grace"</span><span class="op">)</span>,</span>
<span>                       GRP3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cindy"</span>, <span class="st">"lucy"</span>, <span class="st">"alex"</span> <span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can check that students are not assigned to multiple groups:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">student_groups</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/verify_named.html">verify_named_all_values_unique</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Or that the every student has been assigned a group:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## mistakenly assign kate to another group</span></span>
<span><span class="va">student_group_mistake</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>GRP1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"kate"</span>, <span class="st">"jane"</span>, <span class="st">"peter"</span><span class="op">)</span>,</span>
<span>                           GRP2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"terry"</span>, <span class="st">"ben"</span>, <span class="st">"grace"</span><span class="op">)</span>,</span>
<span>                           GRP2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cindy"</span>, <span class="st">"lucy"</span>, <span class="st">"kate"</span> <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">student_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"kate"</span>, <span class="st">"jane"</span>, <span class="st">"peter"</span>, <span class="st">"terry"</span>, <span class="st">"ben"</span>, <span class="st">"grace"</span>, <span class="st">"cindy"</span>, <span class="st">"lucy"</span>, <span class="st">"alex"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">student_group_mistake</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/verify_named_matchset.html">verify_named_matchset_values_exact</a></span><span class="op">(</span><span class="va">student_list</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `verify_named_matchset_values_exact()`:</span></span></span>
<span><span class="co">## <span style="color: #BBBB00;">!</span> The values of `x` do not exactly match `ref_set`</span></span></code></pre>
<p>and each group has a unique name:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">student_group_mistake</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/verify_named.html">verify_named_all_names_unique</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `verify_named_all_names_unique()`:</span></span></span>
<span><span class="co">## <span style="color: #BBBB00;">!</span> Duplicated names found in `x`.</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Use `base::duplicated(names(x))` to identify duplicates.</span></span></code></pre>
<p>Coercion to <code>xmap</code> requires adding weights and is
directional. We can choose to verify conditions and return the same
object via <code>verify_links_*</code> functions, or coerce to an
<code>xmap</code> for use with other functions in the package.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">group_links</span> <span class="op">&lt;-</span> <span class="va">student_groups</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/as_pairs.html">as_pairs_from_named</a></span><span class="op">(</span>names_to <span class="op">=</span> <span class="st">"group"</span>, values_to <span class="op">=</span> <span class="st">"student"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/add_weights.html">add_weights_unit</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## collapse xmap from students to groups</span></span>
<span><span class="va">group_links</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/verify_links_as_xmap.html">verify_links_as_xmap</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">student</span>, to <span class="op">=</span> <span class="va">group</span>, weights <span class="op">=</span> <span class="va">weights</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## reverse doesn't work without adjusting the weights</span></span>
<span><span class="va">group_links</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/verify_links_as_xmap.html">verify_links_as_xmap</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">group</span>, to <span class="op">=</span> <span class="va">student</span>, weights <span class="op">=</span> <span class="va">weights</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `verify_links_as_xmap()`:</span></span></span>
<span><span class="co">## <span style="color: #BBBB00;">!</span> Incomplete mapping weights found</span></span>
<span><span class="co">## <span style="color: #BB0000;">✖</span> `weights` does not sum to 1</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Modify weights or adjust `tol` and try again.</span></span></code></pre>
<p>Aggregation transformations can implemented as Collapse maps.
Additionally, aggregation size requirements can be implemented as
conditions on the number of incoming links for each target node. For
instance, if you know that each target node should aggregate values from
at least two source nodes, then the minimum number of non-zero incoming
links should be 2 for every target node. Notice that this requirement
precludes one-to-one links since it prevents any source node from being
recoded into an “unshared” node in the target nomenclature.</p>
</div>
<div class="section level3">
<h3 id="split-or-redistribution-maps-with-equal-weights">Split or Redistribution maps (with Equal Weights)<a class="anchor" aria-label="anchor" href="#split-or-redistribution-maps-with-equal-weights"></a>
</h3>
<p>Any crossmap with at least one set of fractional weight (one-to-many)
links involve some redistribution of source value. However, a useful
special case of maps with fractional weights are split maps, which
encode the disaggregation of source values into a target nomenclature.
Such maps which will have mostly one-to-many relations, and do not
contain one-from-many relations. This can be ensured by restricting each
target node to only have one incoming link. Furthermore, we can preclude
one-to-one links with the condition that all links must have fractional
weights.</p>
<p>Notice that the same set of node pairs can generate either a split or
collapse map depending on the weights added. For example, recall that in
the student group example from above, swapping the <code>to</code> and
<code>from</code> variables no longer formed a valid crossmap. Now
consider allocating some budget of prizes equally between students in
each group. This requires adding fractional weights to
<code>group_links</code>, which can then be verified as a crossmap.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">group_prize_links</span> <span class="op">&lt;-</span> <span class="va">student_groups</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/as_pairs.html">as_pairs_from_named</a></span><span class="op">(</span><span class="st">"group"</span>, <span class="st">"student"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">group</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>prize_share <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/n_distinct.html" class="external-link">n_distinct</a></span><span class="op">(</span><span class="va">student</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">group_prize_links</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/verify_links_as_xmap.html">verify_links_as_xmap</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">group</span>, to <span class="op">=</span> <span class="va">student</span>, weights <span class="op">=</span> <span class="va">prize_share</span><span class="op">)</span></span></code></pre></div>
<p>Note that if the first crossmap condition is met, i.e. there is only
one link between each unique source-node pair, then
<code><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">dplyr::n()</a></code> and <code><a href="https://dplyr.tidyverse.org/reference/n_distinct.html" class="external-link">dplyr::n_distinct()</a></code> are
interchangeable when generating equal share weights.</p>
</div>
</div>
<div class="section level2">
<h2 id="cheatsheet-for-verifying-mapping-objects">Cheatsheet for Verifying Mapping Objects<a class="anchor" aria-label="anchor" href="#cheatsheet-for-verifying-mapping-objects"></a>
</h2>
<p>Let <span class="math inline">\(G = (U,V, E)\)</span> be a crossmap
where <span class="math inline">\(U\)</span> and <span class="math inline">\(V\)</span> are the source and target nomenclature
sets, and <span class="math inline">\(E\)</span> denotes the graph edges
(i.e. links between the two sets), with weights on a link between node
<span class="math inline">\(i \in U\)</span> and <span class="math inline">\(j \in V\)</span> denoted <span class="math inline">\(w_{ij}\)</span>. Recall also that sets by
definition don’t contain duplicates.</p>
<p>Let us also define some corresponding R objects:</p>
<ul>
<li>
<code>from,to,weights</code> : the vectors or columns defining
non-zero links for a crossmap (i.e an edge list). Each - triplet or row
represents a edge <span class="math inline">\({i,j}\)</span> with weight
<span class="math inline">\(w_{ij}\)</span>. These vectors can contain
duplicates.</li>
<li>
<code>unique(from)</code> : the set <span class="math inline">\(U\)</span> of unique categories in the source
nomenclature</li>
<li>
<code>unique(to)</code>: the set <span class="math inline">\(V\)</span> of unique categories in the target
nomenclature</li>
<li>
<code>df</code>: a data.frame containing
<code>from,to,weights</code>
</li>
<li>
<code>sum_w</code> : a vector the same length as
<code>unique(from)</code> containing sum of <code>weights</code> grouped
by <code>from</code>
</li>
<li>
<code>ones</code>: a vector of ones the same length as
<code>sum_w</code> and <code>unique(from)</code>
</li>
</ul>
<p>Then to check if table of links is a valid crossmap, we just check
that:</p>
<ul>
<li>there are no missing values – i.e. any explicit link has to have a
source, target and weight</li>
<li>we only have one link between each unique source and target node –
i.e. we can’t have two links between <span class="math inline">\(i,j\)</span> with different weights.</li>
<li>the weights on links coming out of each source node sum to 1</li>
</ul>
<p>The <code>xmap</code> function to do this is
<code><a href="../reference/verify_links_as_xmap.html">verify_links_as_xmap()</a></code>. But you can also check the
following base R or dplyr conditions:</p>
<ul>
<li><code>anyNA(df)</code></li>
<li>
<code>anyDuplicated(data.frame(from, to)) == FALSE</code> or
<code>nrow(distinct(df, from, to)) = nrow(df)</code>
</li>
<li>
<code>all(isTRUE(all.equal(sum_w, ones)))</code> or
<code>dplyr::near(sum_w, ones)</code>
</li>
</ul>
<p>Note that using <code>==</code> for the third condition is not
recommended since it doesn’t have any built-in tolerance for floating
point errors.</p>
<p>Strict versions of the above special cases can also be characterised
with the following additional conditions:</p>
<table style="width:99%;" class="table">
<colgroup>
<col width="8%">
<col width="26%">
<col width="28%">
<col width="36%">
</colgroup>
<thead><tr class="header">
<th>x</th>
<th>
<strong>Recoding</strong> (1-to-1)</th>
<th>
<strong>Collapsing</strong> (M-to-1)</th>
<th>
<strong>Splitting</strong> (1-to-M)</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Assertions</td>
<td><ul>
<li>every link weight is either 1 or 0 (implied by absence)</li>
<li>cardinality of the source and target sets is the same</li>
</ul></td>
<td><ul>
<li>link weights are binary</li>
<li>there are more source categories than target categories</li>
<li>each source category is assigned to only one target category</li>
</ul></td>
<td><ul>
<li>link weights are fractional or absent</li>
<li>there are more target categories than source categories</li>
<li>each source category has at least two outgoing links to the target
nomenclature</li>
</ul></td>
</tr>
<tr class="even">
<td>xmap functions</td>
<td>
<p><code><a href="../reference/verify_named.html">verify_named_all_1to1()</a></code></p>
<p><code><a href="../reference/verify_pairs.html">verify_pairs_all_1to1()</a></code></p>
<p>…</p>
</td>
<td>
<p><code><a href="../reference/verify_named.html">verify_named_all_values_unique()</a></code></p>
<p><code>verify_named_matchset</code></p>
<p>…</p>
</td>
<td>
<p><code><a href="../reference/verify_named.html">verify_named_all_names_unique()</a></code></p>
<p><code>verify_named_matchset</code></p>
<p>…</p>
</td>
</tr>
<tr class="odd">
<td>
<p>base R</p>
<p>conditions</p>
</td>
<td><ul>
<li><code>all(weights == 1)</code></li>
<li><code>length(unique(from) == length(unique(to))</code></li>
</ul></td>
<td><ul>
<li><code>all(weights == 1)</code></li>
<li><code>length(unique(from) &gt; length(unique(to))</code></li>
<li><code>length(unique(from)) == length(from)</code></li>
</ul></td>
<td><ul>
<li><code>all(weights &lt; 1)</code></li>
<li><code>length(unique(from)) &lt; length(unique(to))</code></li>
<li><code>length(from) &gt; length(unique(from))</code></li>
</ul></td>
</tr>
<tr class="even">
<td>Graph Conditions</td>
<td><ul>
<li><span class="math inline">\(w_{ij} \in \{0,1\} \ \forall
i,j\)</span></li>
<li><span class="math inline">\(|U| = |V|\)</span></li>
<li><span class="math inline">\(Out_i = In_j = 1 \ \forall
i,j\)</span></li>
</ul></td>
<td><ul>
<li><span class="math inline">\(w_{ij} \in \{0,1\} \forall
i,j\)</span></li>
<li><span class="math inline">\(|U| &gt; |V|\)</span></li>
<li><span class="math inline">\(Out_i = 1 \ \forall i \in
U\)</span></li>
</ul></td>
<td><ul>
<li><span class="math inline">\(w_{ij} \in [0, 1) \forall
i,j\)</span></li>
<li><span class="math inline">\(|U| &lt; |V|\)</span></li>
<li><span class="math inline">\(Out_i &gt; 1 \ \forall i \in
U\)</span></li>
</ul></td>
</tr>
</tbody>
</table>
</div>
<div class="section level2">
<h2 id="creating-xmap_df-from-pairs-and-links">Creating <code>xmap_df</code> from Pairs and Links<a class="anchor" aria-label="anchor" href="#creating-xmap_df-from-pairs-and-links"></a>
</h2>
<p>The following examples demonstrate how to coerce various inputs into
the experimental <code>xmap_df</code> class.</p>
<div class="section level3">
<h3 id="row-wise-links">Row-wise Links<a class="anchor" aria-label="anchor" href="#row-wise-links"></a>
</h3>
<p>The following example shows how to create a mixed crossmap which
encodes one-to-one, many-to-one and one-to-many relations and coerce
them into a <code>xmap_df</code>. This method is most suitable for
simple crossmaps. The exmaple belows shows the code for the sample
crossmap: <code>mock$xmap_abc</code></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">abc_links</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">lower</span>, <span class="op">~</span><span class="va">upper</span>, <span class="op">~</span><span class="va">share</span>,</span>
<span>  <span class="st">"a"</span>, <span class="st">"AA"</span>, <span class="fl">1</span>,       <span class="co"># one-to-one</span></span>
<span>  <span class="st">"b"</span>, <span class="st">"BB"</span>, <span class="fl">1</span>,    <span class="co"># one-FROM-many</span></span>
<span>  <span class="st">"c"</span>, <span class="st">"BB"</span>, <span class="fl">1</span>,</span>
<span>  <span class="st">"d"</span>, <span class="st">"CC"</span>, <span class="fl">0.3</span>,    <span class="co"># one-to-many</span></span>
<span>  <span class="st">"d"</span>, <span class="st">"DD"</span>, <span class="fl">0.6</span>,</span>
<span>  <span class="st">"d"</span>, <span class="st">"EE"</span>, <span class="fl">0.1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">xmap_abc</span> <span class="op">&lt;-</span> <span class="va">abc_links</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/as_xmap.html">as_xmap_df</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">lower</span>, to <span class="op">=</span> <span class="va">upper</span>, weights <span class="op">=</span> <span class="va">share</span><span class="op">)</span></span>
<span></span>
<span><span class="va">xmap_abc</span></span></code></pre></div>
<pre><code><span><span class="co">## xmap_df:</span></span>
<span><span class="co">## recode, split, and collapse  </span></span>
<span><span class="co">## (lower -&gt; upper) BY share</span></span>
<span><span class="co">##   lower upper share</span></span>
<span><span class="co">## 1     a    AA   1.0</span></span>
<span><span class="co">## 2     b    BB   1.0</span></span>
<span><span class="co">## 3     c    BB   1.0</span></span>
<span><span class="co">## 4     d    CC   0.3</span></span>
<span><span class="co">## 5     d    DD   0.6</span></span>
<span><span class="co">## 6     d    EE   0.1</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="crosswalklookup-tables">Crosswalk/Lookup Tables<a class="anchor" aria-label="anchor" href="#crosswalklookup-tables"></a>
</h3>
<p>It is more common that you will want to convert an existing
correspondence into a crossmap. Such conversions require attaching
appropriate weights to the existing crosswalk table.</p>
<div class="section level4">
<h4 id="recode-pairs">Recode Pairs<a class="anchor" aria-label="anchor" href="#recode-pairs"></a>
</h4>
<p>Consider the first five country codes in the ISO 3166 international
standard and the one-to-one correspondence between the 2-digit, 2-digit
and numeric codes.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iso_codes</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>              <span class="op">~</span><span class="va">country</span>, <span class="op">~</span><span class="va">ISO2</span>, <span class="op">~</span><span class="va">ISO3</span>, <span class="op">~</span><span class="va">ISONumeric</span>,</span>
<span>         <span class="st">"Afghanistan"</span>,          <span class="st">"AF"</span>,         <span class="st">"AFG"</span>,    <span class="st">"004"</span>,</span>
<span>             <span class="st">"Albania"</span>,          <span class="st">"AL"</span>,         <span class="st">"ALB"</span>,    <span class="st">"008"</span>,</span>
<span>             <span class="st">"Algeria"</span>,          <span class="st">"DZ"</span>,         <span class="st">"DZA"</span>,    <span class="st">"012"</span>,</span>
<span>      <span class="st">"American Samoa"</span>,          <span class="st">"AS"</span>,         <span class="st">"ASM"</span>,    <span class="st">"016"</span>,</span>
<span>             <span class="st">"Andorra"</span>,          <span class="st">"AD"</span>,         <span class="st">"AND"</span>,    <span class="st">"020"</span></span>
<span>      <span class="op">)</span></span></code></pre></div>
<p>We can verify any pairwise combination of columns as one-to-one
recode maps using the <code>verify_pairs_*</code> functions:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iso_codes</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/verify_pairs.html">verify_pairs_as_recode_unique</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">country</span>, to <span class="op">=</span> <span class="va">ISO2</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 5 × 4</span></span></span>
<span><span class="co">##   country        ISO2  ISO3  ISONumeric</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> Afghanistan    AF    AFG   004       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> Albania        AL    ALB   008       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> Algeria        DZ    DZA   012       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span> American Samoa AS    ASM   016       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span> Andorra        AD    AND   020</span></span></code></pre>
<p>To create a crossmap between <code>ISONumeric</code> and
<code>ISO2</code>, we simply add a weights columns and coerce to
<code>xmap_df</code>:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iso_xmap</span> <span class="op">&lt;-</span> <span class="va">iso_codes</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/add_weights.html">add_weights_unit</a></span><span class="op">(</span>weights_into <span class="op">=</span> <span class="st">"weight"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/as_xmap.html">as_xmap_df</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">ISONumeric</span>, to <span class="op">=</span> <span class="va">ISO2</span>, weights <span class="op">=</span> <span class="va">weight</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Dropped additional columns in `add_weights_unit(iso_codes, weights_into =</span></span>
<span><span class="co">## "weight")`</span></span></code></pre>
<p>Notice that <code><a href="../reference/as_xmap.html">as_xmap_df()</a></code> always place the
<code>from</code>, <code>to</code> and <code>weights</code> columns in
order and drops any additional columns passed to it.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">iso_xmap</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## xmap_df:</span></span>
<span><span class="co">## recode </span></span>
<span><span class="co">## (ISONumeric -&gt; ISO2) BY weight</span></span>
<span><span class="co">##   ISONumeric ISO2 weight</span></span>
<span><span class="co">## 1        004   AF      1</span></span>
<span><span class="co">## 2        008   AL      1</span></span>
<span><span class="co">## 3        012   DZ      1</span></span>
<span><span class="co">## 4        016   AS      1</span></span>
<span><span class="co">## 5        020   AD      1</span></span></code></pre>
<p>To convert the validated xmap into a named vector:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iso_xmap</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/xmap_to_named.html">xmap_to_named_vector</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    AF    AL    DZ    AS    AD </span></span>
<span><span class="co">## "004" "008" "012" "016" "020"</span></span></code></pre>
<p>We can also easily generate validated crossmaps for the other
nomenclature in the table, and keep additional columns:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iso_codes</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/add_weights.html">add_weights_unit</a></span><span class="op">(</span>weights_into <span class="op">=</span> <span class="st">"weight"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/as_xmap.html">as_xmap_df</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">ISO2</span>, to <span class="op">=</span> <span class="va">ISO3</span>, weights <span class="op">=</span> <span class="va">weight</span>, .drop_extra <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## xmap_df:</span></span>
<span><span class="co">## recode </span></span>
<span><span class="co">## (ISO2 -&gt; ISO3) BY weight</span></span>
<span><span class="co">##   ISO2 ISO3 weight        country ISONumeric</span></span>
<span><span class="co">## 1   AF  AFG      1    Afghanistan        004</span></span>
<span><span class="co">## 2   AL  ALB      1        Albania        008</span></span>
<span><span class="co">## 3   DZ  DZA      1        Algeria        012</span></span>
<span><span class="co">## 4   AS  ASM      1 American Samoa        016</span></span>
<span><span class="co">## 5   AD  AND      1        Andorra        020</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="nested-lists">Nested Lists<a class="anchor" aria-label="anchor" href="#nested-lists"></a>
</h4>
<p>Now consider aggregating data which were collected using the ISO
3166-2 Subdivisions of <a href="https://en.wikipedia.org/w/index.php?title=ISO_3166-2:AU&amp;oldid=1110907059" class="external-link">Australia</a>
and <a href="https://en.wikipedia.org/w/index.php?title=ISO_3166-2:CA&amp;oldid=1110906706" class="external-link">Canada</a>:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">adm1_list</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">ctr</span>, <span class="op">~</span><span class="va">adm1</span>,</span>
<span>  <span class="st">"AU"</span>, <span class="st">"AU-NSW, AU-QLD, AU-SA, AU-TAS, AU-VIC, AU-WA, AU-ACT, AU-NT"</span>,</span>
<span>  <span class="st">"CA"</span>, <span class="st">"CA-AB, CA-BC, CA-MB, CA-NB, CA-NL, CA-NS, CA-ON, CA-PE, CA-QC, CA-SK, CA-NT, CA-NU, CA-YT"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Recall that we need one row per relation between the source
(<code>adm1</code>) and target (<code>ctr</code>) nomenclature. Thus we
split the string list into a vector, and then unnest the values by
country.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">agg_x</span> <span class="op">&lt;-</span> <span class="va">adm1_list</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>adm1 <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_split.html" class="external-link">str_split</a></span><span class="op">(</span><span class="va">adm1</span>, <span class="st">", "</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">adm1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">agg_x</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 21 × 2</span></span></span>
<span><span class="co">##    ctr   adm1  </span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> AU    AU-NSW</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> AU    AU-QLD</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> AU    AU-SA </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> AU    AU-TAS</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> AU    AU-VIC</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> AU    AU-WA </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> AU    AU-ACT</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> AU    AU-NT </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> CA    CA-AB </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> CA    CA-BC </span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 11 more rows</span></span></span></code></pre>
<p>Since aggregation involves the one-to-one transfer of values between
<code>adm1</code> and <code>ctr</code> prior to the collapsing the
<code>ctr</code> groups, we simple add unit weights to form a valid
crossmap:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">agg_xmap</span> <span class="op">&lt;-</span> <span class="va">agg_x</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/add_weights.html">add_weights_unit</a></span><span class="op">(</span>weights_into <span class="op">=</span> <span class="st">"link"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/as_xmap.html">as_xmap_df</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">adm1</span>, to <span class="op">=</span> <span class="va">ctr</span>, weights <span class="op">=</span> <span class="va">link</span><span class="op">)</span></span>
<span></span>
<span><span class="va">agg_xmap</span></span></code></pre></div>
<pre><code><span><span class="co">## xmap_df:</span></span>
<span><span class="co">## recode and collapse  </span></span>
<span><span class="co">## (adm1 -&gt; ctr) BY link</span></span>
<span><span class="co">##      adm1 ctr link</span></span>
<span><span class="co">## 1  AU-NSW  AU    1</span></span>
<span><span class="co">## 2  AU-QLD  AU    1</span></span>
<span><span class="co">## 3   AU-SA  AU    1</span></span>
<span><span class="co">## 4  AU-TAS  AU    1</span></span>
<span><span class="co">## 5  AU-VIC  AU    1</span></span>
<span><span class="co">## 6   AU-WA  AU    1</span></span>
<span><span class="co">## 7  AU-ACT  AU    1</span></span>
<span><span class="co">## 8   AU-NT  AU    1</span></span>
<span><span class="co">## 9   CA-AB  CA    1</span></span>
<span><span class="co">## 10  CA-BC  CA    1</span></span>
<span><span class="co">## 11  CA-MB  CA    1</span></span>
<span><span class="co">## 12  CA-NB  CA    1</span></span>
<span><span class="co">## 13  CA-NL  CA    1</span></span>
<span><span class="co">## 14  CA-NS  CA    1</span></span>
<span><span class="co">## 15  CA-ON  CA    1</span></span>
<span><span class="co">## 16  CA-PE  CA    1</span></span>
<span><span class="co">## 17  CA-QC  CA    1</span></span>
<span><span class="co">## 18  CA-SK  CA    1</span></span>
<span><span class="co">## 19  CA-NT  CA    1</span></span>
<span><span class="co">## 20  CA-NU  CA    1</span></span>
<span><span class="co">## 21  CA-YT  CA    1</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="references-for-custom-weights">References for Custom Weights<a class="anchor" aria-label="anchor" href="#references-for-custom-weights"></a>
</h4>
<p>Conversely, we might have aggregate level data which want to
disaggregate. Continuing the above example, this could involve
incorporating country level data into analysis at the 3166-2
Subdivisions level.</p>
<p>For example, imagine that we have population figures for Australia at
the 3166-2 level for 9 out of 10 years, but only country level figures
for the missing year. In this simple example, a reasonable harmonisation
design could involve splitting the country level figure by the
subdivision level population proportions from the year preceding or
following the missing year.</p>
<p>Alternatively, we might want to compare aggregate and disaggregate
statistics to identify discrepancies.</p>
<p>Using Australian population statistics from 30 Jun 2022<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Source: &lt;a href="https://www.abs.gov.au/statistics/people/population/national-state-and-territory-population/jun-2022" class="external-link"&gt;Australian
Bureau of Statistics&lt;/a&gt;&lt;/p&gt;'><sup>1</sup></a></p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">state_data</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>                              <span class="op">~</span><span class="va">state</span>,    <span class="op">~</span><span class="va">adm1</span>,    <span class="op">~</span><span class="va">Pop</span>,</span>
<span>                   <span class="st">"New South Wales"</span>, <span class="st">"AU-NSW"</span>, <span class="fl">8153600</span>,</span>
<span>                          <span class="st">"Victoria"</span>, <span class="st">"AU-VIC"</span>, <span class="fl">6613700</span>,</span>
<span>                        <span class="st">"Queensland"</span>, <span class="st">"AU-QLD"</span>, <span class="fl">5322100</span>,</span>
<span>                   <span class="st">"South Australia"</span>,  <span class="st">"AU-SA"</span>, <span class="fl">1820500</span>,</span>
<span>                 <span class="st">"Western Australia"</span>,  <span class="st">"AU-WA"</span>, <span class="fl">2785300</span>,</span>
<span>                          <span class="st">"Tasmania"</span>, <span class="st">"AU-TAS"</span>,  <span class="fl">571500</span>,</span>
<span>                <span class="st">"Northern Territory"</span>,  <span class="st">"AU-NT"</span>,  <span class="fl">250600</span>,</span>
<span>      <span class="st">"Australian Capital Territory"</span>, <span class="st">"AU-ACT"</span>,  <span class="fl">456700</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">state_xmap</span> <span class="op">&lt;-</span> <span class="va">state_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ctr <span class="op">=</span> <span class="st">"AU"</span>,</span>
<span>                <span class="va">adm1</span>,</span>
<span>                share <span class="op">=</span> <span class="va">Pop</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Pop</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/as_xmap.html">as_xmap_df</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">ctr</span>, to <span class="op">=</span> <span class="va">adm1</span>, weights <span class="op">=</span> <span class="va">share</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Dropped additional columns in `dplyr::mutate(state_data, ctr = "AU", adm1,</span></span>
<span><span class="co">## share = Pop/sum(Pop))`</span></span></code></pre>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">state_xmap</span></span></code></pre></div>
<pre><code><span><span class="co">## xmap_df:</span></span>
<span><span class="co">## split </span></span>
<span><span class="co">## (ctr -&gt; adm1) BY share</span></span>
<span><span class="co">##   ctr   adm1      share</span></span>
<span><span class="co">## 1  AU AU-NSW 0.31391391</span></span>
<span><span class="co">## 2  AU AU-VIC 0.25462770</span></span>
<span><span class="co">## 3  AU AU-QLD 0.20490105</span></span>
<span><span class="co">## 4  AU  AU-SA 0.07008932</span></span>
<span><span class="co">## 5  AU  AU-WA 0.10723416</span></span>
<span><span class="co">## 6  AU AU-TAS 0.02200277</span></span>
<span><span class="co">## 7  AU  AU-NT 0.00964811</span></span>
<span><span class="co">## 8  AU AU-ACT 0.01758297</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="piecewise-construction">Piecewise Construction<a class="anchor" aria-label="anchor" href="#piecewise-construction"></a>
</h3>
<p>Now consider the following mixed transformation using selected
correspondences between NAICS Canada 1997 and ISIC Revision 3. Imagine
that we have some numeric data (e.g. gross output in CAD) collected in
the NAICS Canada nomenclature that we want to harmonise into ISIC
Revision 3. The correspondence between the two nomenclature contains a
mixture of one-to-one, one-to-many, and one-from-many relations.</p>
<p>Luckily, we can split the source nomenclature into two groups:</p>
<ol style="list-style-type: decimal">
<li>source nodes with only one outgoing link (one-to-one relations with
unit weights)</li>
<li>source nodes with multiple outgoing links (one-to-many relations
with fractional weights)</li>
</ol>
<p>Let’s first define somed example correspondences.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;based on examples provided by Statistics Canada on the
page &lt;a href="https://www.statcan.gc.ca/en/subjects/standard/concordances/concordanc_tabl3" class="external-link"&gt;How
to Read a Concordance Table&lt;/a&gt;.&lt;/p&gt;'><sup>2</sup></a></p>
<p>In the first example, one NAICS Canada class relates to exactly one
ISIC class, forming a one-to-one relation.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">canada_recode</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  NAICS1997      <span class="op">=</span> <span class="st">"212210"</span>, </span>
<span>  NAICS1997_desc <span class="op">=</span> <span class="st">"Iron Ore Mining"</span>,</span>
<span>  ISIC3          <span class="op">=</span> <span class="st">"C1310"</span>,</span>
<span>  ISIC3_desc    <span class="op">=</span> <span class="st">"Mining of iron ores"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">NAICS1997</th>
<th align="left">NAICS1997_desc</th>
<th align="left">ISIC3</th>
<th align="left">ISIC3_desc</th>
</tr></thead>
<tbody><tr class="odd">
<td align="left">212210</td>
<td align="left">Iron Ore Mining</td>
<td align="left">C1310</td>
<td align="left">Mining of iron ores</td>
</tr></tbody>
</table>
<p>In the second example, the ISIC target class <code>D1543</code> is
equivalent to more than one NAICS Canada source class, forming a
one-from-many relation. The asterisk (Partial Flag) indicates that part
of ISIC D1543 is equivalent to each NAICS Canada class. The ISIC
activities corresponding to each NAICS Canada class are listed in the
column labelled “Link”.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">canada_agg</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">NAICS1997</span>, <span class="op">~</span><span class="va">NAICS1997_desc</span>, <span class="op">~</span><span class="va">ISIC3</span>, <span class="op">~</span><span class="va">ISIC3_desc</span>, <span class="op">~</span><span class="va">Link</span>,</span>
<span>  <span class="st">"311320"</span>, <span class="st">"Chocolate and Confectionery Manufacturing from Cacao Beans"</span>, <span class="st">"D1543 *"</span>, <span class="st">"Manufacture of cocoa, chocolate and sugar confectionery"</span>, <span class="st">"Chocolate and confectionery, made from cacao beans"</span>,</span>
<span>  <span class="st">"311330"</span>, <span class="st">"Confectionery Manufacturing from Purchased Chocolate"</span>, <span class="st">"D1543 *"</span>, <span class="st">"Manufacture of cocoa, chocolate and sugar confectionery"</span>, <span class="st">"Confectionery, made from purchased chocolate"</span>,</span>
<span>  <span class="st">"311340"</span>, <span class="st">"Non-Chocolate Confectionery Manufacturing"</span>, <span class="st">"D1543 *"</span>, <span class="st">"Manufacture of cocoa, chocolate and sugar confectionery"</span>, <span class="st">"Non-chocolate confectionery, manufacturing"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="5%">
<col width="32%">
<col width="4%">
<col width="30%">
<col width="27%">
</colgroup>
<thead><tr class="header">
<th align="left">NAICS1997</th>
<th align="left">NAICS1997_desc</th>
<th align="left">ISIC3</th>
<th align="left">ISIC3_desc</th>
<th align="left">Link</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">311320</td>
<td align="left">Chocolate and Confectionery Manufacturing from Cacao
Beans</td>
<td align="left">D1543 *</td>
<td align="left">Manufacture of cocoa, chocolate and sugar
confectionery</td>
<td align="left">Chocolate and confectionery, made from cacao beans</td>
</tr>
<tr class="even">
<td align="left">311330</td>
<td align="left">Confectionery Manufacturing from Purchased
Chocolate</td>
<td align="left">D1543 *</td>
<td align="left">Manufacture of cocoa, chocolate and sugar
confectionery</td>
<td align="left">Confectionery, made from purchased chocolate</td>
</tr>
<tr class="odd">
<td align="left">311340</td>
<td align="left">Non-Chocolate Confectionery Manufacturing</td>
<td align="left">D1543 *</td>
<td align="left">Manufacture of cocoa, chocolate and sugar
confectionery</td>
<td align="left">Non-chocolate confectionery, manufacturing</td>
</tr>
</tbody>
</table>
<p>Notice that for both one-to-one and one-from-many relations, values
attached to each source category are not directly modified during the
“transfer” between source and target nomenclature. Instead, the source
values are either retained, or summarised when the category collapse
(and value aggregation) is performed. Thus, as shown above, all links in
the above examples will take unit weights.</p>
<p>In this third example, one souce NAICS Canada class is equivalent to
more than one target ISIC class, forming a one-to-many relation.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">canada_split</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">NAICS1997</span>, <span class="op">~</span><span class="va">NAICS1997_desc</span>, <span class="op">~</span><span class="va">ISIC3</span>, <span class="op">~</span><span class="va">ISIC3_desc</span>, <span class="op">~</span><span class="va">Link</span>,</span>
<span>  <span class="st">"483213"</span>, <span class="st">"Inland Water Transportation (except by Ferries)"</span>, <span class="st">"I6110 *"</span>, <span class="st">"Sea and coastal water transport"</span>, <span class="st">"Intracoastal water transportation"</span>,</span>
<span>  <span class="st">"483213"</span>, <span class="st">"Inland Water Transportation (except by Ferries)"</span>, <span class="st">"I6120 *"</span>, <span class="st">"Inland water transport"</span>, <span class="st">"Inland water transportation (except ferries)"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="6%">
<col width="33%">
<col width="5%">
<col width="22%">
<col width="31%">
</colgroup>
<thead><tr class="header">
<th align="left">NAICS1997</th>
<th align="left">NAICS1997_desc</th>
<th align="left">ISIC3</th>
<th align="left">ISIC3_desc</th>
<th align="left">Link</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">483213</td>
<td align="left">Inland Water Transportation (except by Ferries)</td>
<td align="left">I6110 *</td>
<td align="left">Sea and coastal water transport</td>
<td align="left">Intracoastal water transportation</td>
</tr>
<tr class="even">
<td align="left">483213</td>
<td align="left">Inland Water Transportation (except by Ferries)</td>
<td align="left">I6120 *</td>
<td align="left">Inland water transport</td>
<td align="left">Inland water transportation (except ferries)</td>
</tr>
</tbody>
</table>
<p>Let’s clean up the recode and collapse relations shown above:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">canada_unit</span> <span class="op">&lt;-</span> <span class="va">canada_agg</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># remove the partial flag (*)</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ISIC3 <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove</a></span><span class="op">(</span><span class="va">ISIC3</span>, <span class="st">" \\*"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">Link</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># bind the links together and add weights</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">canada_recode</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>share <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<table style="width:100%;" class="table">
<colgroup>
<col width="7%">
<col width="43%">
<col width="4%">
<col width="40%">
<col width="4%">
</colgroup>
<thead><tr class="header">
<th align="left">NAICS1997</th>
<th align="left">NAICS1997_desc</th>
<th align="left">ISIC3</th>
<th align="left">ISIC3_desc</th>
<th align="right">share</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">311320</td>
<td align="left">Chocolate and Confectionery Manufacturing from Cacao
Beans</td>
<td align="left">D1543</td>
<td align="left">Manufacture of cocoa, chocolate and sugar
confectionery</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">311330</td>
<td align="left">Confectionery Manufacturing from Purchased
Chocolate</td>
<td align="left">D1543</td>
<td align="left">Manufacture of cocoa, chocolate and sugar
confectionery</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">311340</td>
<td align="left">Non-Chocolate Confectionery Manufacturing</td>
<td align="left">D1543</td>
<td align="left">Manufacture of cocoa, chocolate and sugar
confectionery</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">212210</td>
<td align="left">Iron Ore Mining</td>
<td align="left">C1310</td>
<td align="left">Mining of iron ores</td>
<td align="right">1</td>
</tr>
</tbody>
</table>
<p>Now all that remains is to prepare the split links. Similar to the
disaggregation example above, we need to design weights to allocate the
“pool” of numeric value associated with the NAICS class
<code>483213</code> into the corresponding ISIC classes
<code>I6110</code> and <code>I6120</code>.</p>
<p>Assume for illustration purposes that we have reference data to
suggest the Canadian “Inland water transport” industry
(<code>I6120</code>) is twice as big as the “Sea and coastal water
transport” industry (<code>I6110</code>). This suggests that the weight
between <code>483213</code> and <code>I6120</code> should be twice that
of <code>I6110</code>.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">canada_frac</span> <span class="op">&lt;-</span> <span class="va">canada_split</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ISIC3 <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove</a></span><span class="op">(</span><span class="va">ISIC3</span>, <span class="st">" \\*"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">Link</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>share <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span><span class="va">ISIC3</span> <span class="op">==</span> <span class="st">"I6110"</span> <span class="op">~</span> <span class="fl">0.33</span>,</span>
<span>                                  <span class="va">ISIC3</span> <span class="op">==</span> <span class="st">"I6120"</span> <span class="op">~</span> <span class="fl">0.67</span>,</span>
<span>                                  <span class="cn">T</span> <span class="op">~</span> <span class="cn">NA_real_</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now let’s combine the unit and fractional links into a crossmap:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">canada_xmap</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">canada_unit</span>, <span class="va">canada_frac</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/as_xmap.html">as_xmap_df</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">NAICS1997</span>, to <span class="op">=</span> <span class="va">ISIC3</span>, weights <span class="op">=</span> <span class="va">share</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Dropped additional columns in `dplyr::bind_rows(canada_unit,</span></span>
<span><span class="co">## canada_frac)`</span></span></code></pre>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">canada_xmap</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## xmap_df:</span></span>
<span><span class="co">## recode, split, and collapse  </span></span>
<span><span class="co">## (NAICS1997 -&gt; ISIC3) BY share</span></span>
<span><span class="co">##   NAICS1997 ISIC3 share</span></span>
<span><span class="co">## 1    311320 D1543  1.00</span></span>
<span><span class="co">## 2    311330 D1543  1.00</span></span>
<span><span class="co">## 3    311340 D1543  1.00</span></span>
<span><span class="co">## 4    212210 C1310  1.00</span></span>
<span><span class="co">## 5    483213 I6110  0.33</span></span>
<span><span class="co">## 6    483213 I6120  0.67</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="reversing-crossmaps">Reversing Crossmaps<a class="anchor" aria-label="anchor" href="#reversing-crossmaps"></a>
</h2>
<div class="section level3">
<h3 id="one-way-maps">One-Way Maps<a class="anchor" aria-label="anchor" href="#one-way-maps"></a>
</h3>
<p>Except in the case of recoding, crossmaps are generally lateral
(one-way). Weights on collapse and split links are no longer valid if
you reverse the direct of the link. Notice that
<code><a href="../reference/as_xmap.html">as_xmap_df()</a></code> throws an error if you try to naively swap the
<code>from</code> and <code>to</code> arguments:</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">canada_unit</span>, <span class="va">canada_frac</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/as_xmap.html">as_xmap_df</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">ISIC3</span>, to <span class="op">=</span> <span class="va">NAICS1997</span>, weights <span class="op">=</span> <span class="va">share</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Dropped additional columns in `dplyr::bind_rows(canada_unit,</span></span>
<span><span class="co">## canada_frac)`</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `as_xmap_df()`:</span></span></span>
<span><span class="co">## <span style="color: #BBBB00;">!</span> Incomplete mapping weights found</span></span>
<span><span class="co">## <span style="color: #BB0000;">✖</span> `share` does not sum to 1</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Modify weights or adjust `tol` and try again.</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="reversible-maps">Reversible Maps<a class="anchor" aria-label="anchor" href="#reversible-maps"></a>
</h3>
<p>However, we <strong>can</strong> swap the arguments on a recode map.
Recall the ISO country code crossmap we created above:</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">iso_xmap</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## xmap_df:</span></span>
<span><span class="co">## recode </span></span>
<span><span class="co">## (ISONumeric -&gt; ISO2) BY weight</span></span>
<span><span class="co">##   ISONumeric ISO2 weight</span></span>
<span><span class="co">## 1        004   AF      1</span></span>
<span><span class="co">## 2        008   AL      1</span></span>
<span><span class="co">## 3        012   DZ      1</span></span>
<span><span class="co">## 4        016   AS      1</span></span>
<span><span class="co">## 5        020   AD      1</span></span></code></pre>
<p>Imagine that instead of converting country codes from ISO Numeric to
ISO-2 digit, we wanted to convert from ISO-2 digit to ISO Numeric. We
can take the existing crossmap and invert it without editing any
weights:</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iso_xmap</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/xmap_reverse.html">xmap_reverse</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## xmap_df:</span></span>
<span><span class="co">## recode </span></span>
<span><span class="co">## (ISO2 -&gt; ISONumeric) BY r_weights</span></span>
<span><span class="co">##   ISO2 ISONumeric r_weights</span></span>
<span><span class="co">## 1   AF        004         1</span></span>
<span><span class="co">## 2   AL        008         1</span></span>
<span><span class="co">## 3   DZ        012         1</span></span>
<span><span class="co">## 4   AS        016         1</span></span>
<span><span class="co">## 5   AD        020         1</span></span></code></pre>
<p>A less trivial reversal is creating an aggregation map from a
disaggregation map. Recall the country to state level disaggregation map
we created above:</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">state_xmap</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/xmap_drop_extra.html">xmap_drop_extra</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## xmap_df:</span></span>
<span><span class="co">## split </span></span>
<span><span class="co">## (ctr -&gt; adm1) BY share</span></span>
<span><span class="co">##   ctr   adm1      share</span></span>
<span><span class="co">## 1  AU AU-NSW 0.31391391</span></span>
<span><span class="co">## 2  AU AU-VIC 0.25462770</span></span>
<span><span class="co">## 3  AU AU-QLD 0.20490105</span></span>
<span><span class="co">## 4  AU  AU-SA 0.07008932</span></span>
<span><span class="co">## 5  AU  AU-WA 0.10723416</span></span>
<span><span class="co">## 6  AU AU-TAS 0.02200277</span></span>
<span><span class="co">## 7  AU  AU-NT 0.00964811</span></span>
<span><span class="co">## 8  AU AU-ACT 0.01758297</span></span></code></pre>
<p>Now imagine we wanted to re-aggregate the data, say after some
state-level adjustments:</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">state_xmap</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/xmap_reverse.html">xmap_reverse</a></span><span class="op">(</span>weights_into <span class="op">=</span> <span class="st">"agg_w"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/xmap_drop_extra.html">xmap_drop_extra</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## xmap_df:</span></span>
<span><span class="co">## recode and collapse  </span></span>
<span><span class="co">## (adm1 -&gt; ctr) BY agg_w</span></span>
<span><span class="co">##     adm1 ctr agg_w</span></span>
<span><span class="co">## 1 AU-NSW  AU     1</span></span>
<span><span class="co">## 2 AU-VIC  AU     1</span></span>
<span><span class="co">## 3 AU-QLD  AU     1</span></span>
<span><span class="co">## 4  AU-SA  AU     1</span></span>
<span><span class="co">## 5  AU-WA  AU     1</span></span>
<span><span class="co">## 6 AU-TAS  AU     1</span></span>
<span><span class="co">## 7  AU-NT  AU     1</span></span>
<span><span class="co">## 8 AU-ACT  AU     1</span></span></code></pre>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://www.cynthiahqy.com" class="external-link">Cynthia Huang</a>, <a href="https://sites.google.com/site/laurapuzzello" class="external-link">Laura Puzzello</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
